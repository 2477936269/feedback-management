# 反馈系统综合设计文档

## 一、需求分析

### 1. 产品定位与目标

为企业搭建一套「用户反馈全流程管理系统」，实现从用户提交反馈、内部处理流转到数据分析优化的闭环，同时支持外部系统通过接口集成方式接入反馈功能，最终提升产品迭代效率和用户满意度。

### 2. 核心用户角色



*   **普通用户**：提交产品反馈（问题 / 建议），查看反馈处理进度。

*   **系统管理员**：管理反馈、配置系统规则（如自动分类关键词）、查看数据分析报表。

*   **外部系统**：通过 API 接口与反馈系统交互，实现自动提交反馈、查询反馈进展等功能。

### 3. 核心功能需求



| 模块       | 具体需求                                                                                                                                         |
| -------- | -------------------------------------------------------------------------------------------------------------------------------------------- |
| **反馈提交** | - 匿名用户可直接填写反馈（文本 + 图片 / 视频），无需登录- 提交时可选反馈类型（如 “功能异常”“体验建议”“新功能需求”“其他”）- 提交后生成唯一反馈 ID，用户需记录 ID 用于后续查询- **外部系统可通过 API 接口提交反馈，支持批量提交和带系统标识的反馈** |
| **反馈查询** | - 匿名用户可通过 “反馈 ID” 查询处理进度（无 ID 则无法查询）- 系统管理员可查看全量反馈，支持按状态、类型、时间筛选- 支持搜索反馈内容关键词- **外部系统可通过 API 接口查询自身提交的反馈列表及单个反馈详情**                          |
| **反馈处理** | - 系统管理员手动处理反馈（状态流转：待处理→处理中→已解决 / 已拒绝）- 处理后，用户通过 ID 查询时可看到处理结果- **外部系统可通过 API 接口接收反馈状态变更的通知或主动查询状态更新**                                        |
| **数据分析** | - 系统管理员可查看反馈统计看板（分类占比、处理时长等）- 趋势图表：按日 / 周 / 月展示反馈数量变化- 支持导出 Excel 报表（筛选后的数据）- **外部系统可通过 API 接口获取授权范围内的反馈统计数据**                               |
| **系统管理** | - 反馈类型配置（新增 / 编辑 / 删除反馈类型选项）- 上传限制配置（修改最大文件数、单个文件大小限制）- 接口密钥管理（生成 / 重置外部调用 API 的密钥）- **外部系统授权管理（配置可访问的接口范围、数据权限和调用频率限制）**                    |

### 4. 非功能需求



*   **性能**：页面加载≤2 秒，反馈提交接口响应≤1 秒，支持日均 5 万级反馈量，**外部 API 接口支持每秒 100 次的并发调用**。

*   **安全**：用户数据加密存储，敏感操作需二次确认，接口防 SQL 注入、XSS 攻击，**外部 API 接口采用密钥认证、数据传输加密和请求签名机制**。

*   **易用性**：操作流程简洁（用户提交反馈不超过 3 步），UI 符合直觉（参考主流管理系统），**提供完整的 API 文档和调试工具供外部系统集成**。

*   **可扩展性**：支持后续接入 AI 自动分类、客服机器人等功能，**API 接口设计遵循 RESTful 规范，保证向后兼容性**。

## 二、结构设计

### 1. 整体架构



```
┌─────────────────┐      ┌─────────────────────────────────┐

│   前端应用      │      │            后端服务             │

│  (匿名用户使用)  │◄────►│  (无认证逻辑，直接处理请求)      │

└─────────────────┘      └───────────┬─────────────────────┘

&#x20;                                   │

┌─────────────────┐                 │

│  外部系统       │◄────────────────┘

│  (API调用)      │                  │

└─────────────────┘                  ▼

&#x20;                             ┌───────────┐

&#x20;                             │ PostgreSQL │

&#x20;                             │（反馈数据/日志）│

&#x20;                             └───────────┘
```

### 2. 项目结构



```
feedback-system/

├── backend/                 # Node.js后端

│   ├── src/

│   │   ├── controllers/     # 控制器

│   │   │   ├── public/      # 前台接口控制器

│   │   │   ├── admin/       # 后台接口控制器

│   │   │   └── external/    # 外部系统接口控制器

│   │   ├── middleware/      # 中间件

│   │   │   ├── auth/        # 认证中间件（含外部API密钥验证）

│   │   │   ├── rateLimit/   # 限流中间件

│   │   │   └── validation/  # 请求验证中间件

│   │   ├── routes/          # 路由

│   │   │   ├── public.ts    # 前台路由

│   │   │   ├── admin.ts     # 后台路由

│   │   │   └── external.ts  # 外部系统路由

│   │   ├── services/        # 业务逻辑

│   │   ├── types/           # TypeScript类型定义

│   │   ├── utils/           # 工具函数

│   │   └── app.ts           # 应用入口

│   ├── prisma/              # Prisma配置

│   ├── docs/                # API文档

│   └── package.json

│

└── frontend/                # React前端

&#x20;   ├── src/

&#x20;   │   ├── components/      # 组件

&#x20;   │   ├── pages/           # 页面

&#x20;   │   │   ├── public/      # 前台页面

&#x20;   │   │   └── admin/       # 后台页面

&#x20;   │   ├── services/        # API服务

&#x20;   │   ├── types/           # TypeScript类型

&#x20;   │   └── App.tsx          # 应用入口

&#x20;   └── package.json
```

### 3. 页面结构

#### （1）前台页面



*   反馈提交页：用于匿名用户提交反馈内容和附件

*   反馈查询页：用于匿名用户通过反馈 ID 查询处理进度和结果

#### （2）后台管理页面



*   反馈管理列表页：查看 / 筛选 / 批量处理反馈

*   反馈处理详情页：处理单条反馈（更新状态 + 添加回复）

*   数据分析看板页：展示反馈统计数据

*   系统设置页：配置系统基础规则

*   **外部系统管理页：管理外部系统授权、API 密钥和访问权限**

## 三、数据库设计

### 1. 核心表结构（Prisma Schema）



```
// 反馈主表

model Feedback {

&#x20; id          String   @id @default(uuid()) // 唯一标识（UUID）

&#x20; feedbackNo  String   @unique // 展示给用户的反馈ID（6位数字+字母）

&#x20; type        String   // 反馈类型（关联配置表）

&#x20; content     String   // 反馈文本内容

&#x20; status      String   @default("PENDING") // 状态：PENDING/PROCESSING/SOLVED/REJECTED

&#x20; reply       String?  // 处理回复（仅SOLVED/REJECTED时有值）

&#x20; createdAt   DateTime @default(now()) // 提交时间

&#x20; updatedAt   DateTime @updatedAt // 更新时间（状态变更时）

&#x20; mediaFiles  MediaFile\[] // 关联的媒体文件

&#x20; operationLogs OperationLog\[] // 关联的操作日志

&#x20; externalSystemId String? // 外部系统ID，为空表示用户提交

&#x20; externalSystem ExternalSystem? @relation(fields: \[externalSystemId], references: \[id])

}

// 媒体文件表（反馈附件）

model MediaFile {

&#x20; id          String   @id @default(uuid())

&#x20; feedbackId  String

&#x20; feedback    Feedback @relation(fields: \[feedbackId], references: \[id], onDelete: Cascade)

&#x20; fileName    String   // 文件名

&#x20; fileUrl     String   // 文件存储路径（如：/media/feedback/xxx.jpg）

&#x20; fileType    String   // 文件类型（image/jpeg, video/mp4等）

&#x20; fileSize    Int      // 文件大小（字节）

&#x20; createdAt   DateTime @default(now())

}

// 操作日志表（记录管理员处理行为）

model OperationLog {

&#x20; id          String   @id @default(uuid())

&#x20; feedbackId  String

&#x20; feedback    Feedback @relation(fields: \[feedbackId], references: \[id], onDelete: Cascade)

&#x20; action      String   // 操作类型：UPDATE\_STATUS/REPLY

&#x20; content     String   // 操作内容（如：状态从PENDING改为PROCESSING）

&#x20; operator    String   @default("admin") // 操作人（固定为admin）

&#x20; createdAt   DateTime @default(now())

}

// 系统配置表

model SystemConfig {

&#x20; id          String   @id @default(uuid())

&#x20; key         String   @unique // 配置键：FEEDBACK\_TYPES/UPLOAD\_LIMIT等

&#x20; value       String   // 配置值（JSON字符串）

&#x20; updatedAt   DateTime @updatedAt

}

// 外部调用API密钥表

model ApiKey {

&#x20; id          String   @id @default(uuid())

&#x20; key         String   @unique // 加密存储的API密钥

&#x20; status      Boolean  @default(true) // 是否启用

&#x20; createdAt   DateTime @default(now())

&#x20; updatedAt   DateTime @updatedAt

&#x20; externalSystemId String

&#x20; externalSystem ExternalSystem @relation(fields: \[externalSystemId], references: \[id])

}

// 外部系统表

model ExternalSystem {

&#x20; id          String   @id @default(uuid())

&#x20; name        String   @unique // 外部系统名称

&#x20; description String?  // 系统描述

&#x20; status      Boolean  @default(true) // 是否启用

&#x20; permissions String\[] // 权限列表，如\["feedback:submit", "feedback:query", "stats:view"]

&#x20; rateLimit   Int      @default(100) // 每秒最大调用次数

&#x20; createdAt   DateTime @default(now())

&#x20; updatedAt   DateTime @updatedAt

&#x20; apiKeys     ApiKey\[]

&#x20; feedbacks   Feedback\[]

}

// API调用日志表

model ApiCallLog {

&#x20; id          String   @id @default(uuid())

&#x20; externalSystemId String

&#x20; externalSystem ExternalSystem @relation(fields: \[externalSystemId], references: \[id])

&#x20; apiPath     String   // 调用的API路径

&#x20; method      String   // HTTP方法

&#x20; statusCode  Int      // 响应状态码

&#x20; requestTime DateTime @default(now()) // 请求时间

&#x20; responseTime Int?    // 响应时间（毫秒）

&#x20; requestId   String   // 请求唯一标识

}
```

### 2. 表关系说明



*   `Feedback` ←→ `MediaFile`：一对多（一个反馈可关联多个媒体文件）

*   `Feedback` ←→ `OperationLog`：一对多（一个反馈可有多条处理日志）

*   `SystemConfig`：单条记录存储所有配置（通过`key`区分不同配置项）

*   `ExternalSystem` ←→ `ApiKey`：一对多（一个外部系统可拥有多个 API 密钥）

*   `ExternalSystem` ←→ `Feedback`：一对多（一个外部系统可提交多个反馈）

*   `ExternalSystem` ←→ `ApiCallLog`：一对多（记录外部系统的 API 调用日志）

### 3. 索引设计



*   反馈表（`Feedback`）：


    *   `status` 字段：加速按状态筛选查询

    *   `type` 字段：加速按类型筛选查询

    *   `createdAt` 字段：加速按时间范围筛选和排序

    *   `feedbackNo` 字段：加速按反馈 ID 查询

    *   `externalSystemId` 字段：加速查询特定外部系统的反馈

*   媒体文件表（`MediaFile`）：


    *   `feedbackId` 字段：加速查询某个反馈的所有附件

*   操作日志表（`OperationLog`）：


    *   `feedbackId` 字段：加速查询某个反馈的所有操作日志

    *   `createdAt` 字段：加速按时间查看操作日志

*   API 调用日志表（`ApiCallLog`）：


    *   `externalSystemId` 字段：加速查询特定外部系统的调用记录

    *   `requestTime` 字段：加速按时间范围查询调用记录

    *   `apiPath` 字段：加速按 API 路径统计调用次数

## 四、接口设计

### 1. 前台接口（匿名访问，无需鉴权）

#### （1）提交反馈



*   **路径**：`POST /api/public/feedback`

*   **参数**（FormData）：



```
{

&#x20; "type": "功能异常", // 反馈类型

&#x20; "content": "登录按钮点击无反应", // 文本内容

&#x20; "files": \[file1, file2] // 媒体文件（可选）

}
```



*   **响应**（200 OK）：



```
{

&#x20; "success": true,

&#x20; "data": {

&#x20;   "feedbackNo": "A1B2C3", // 反馈ID（用户查询用）

&#x20;   "message": "反馈提交成功，请保存ID用于查询进度"

&#x20; }

}
```

#### （2）查询反馈



*   **路径**：`GET /api/public/feedback/{feedbackNo}`

*   **参数**：路径参数`feedbackNo`（用户提供的反馈 ID）

*   **响应**（200 OK）：



```
{

&#x20; "success": true,

&#x20; "data": {

&#x20;   "feedbackNo": "A1B2C3",

&#x20;   "type": "功能异常",

&#x20;   "content": "登录按钮点击无反应",

&#x20;   "status": "SOLVED",

&#x20;   "reply": "已修复，建议刷新页面重试",

&#x20;   "createdAt": "2025-08-12T10:00:00Z",

&#x20;   "mediaFiles": \[

&#x20;     {

&#x20;       "fileUrl": "/media/feedback/xxx.jpg",

&#x20;       "fileName": "截图.jpg"

&#x20;     }

&#x20;   ]

&#x20; }

}
```

### 2. 后台管理接口（需管理员密钥鉴权）

鉴权方式：所有接口需在请求头携带`X-Admin-Key: {管理员密钥}`（密钥在系统设置页配置）

#### （1）获取反馈列表



*   **路径**：`GET /api/admin/feedbacks`

*   **参数**（Query）：



```
{

&#x20; "status": "PENDING", // 可选：筛选状态

&#x20; "type": "功能异常", // 可选：筛选类型

&#x20; "startTime": "2025-08-01", // 可选：开始时间

&#x20; "endTime": "2025-08-12", // 可选：结束时间

&#x20; "keyword": "登录", // 可选：搜索内容

&#x20; "externalSystemId": "sys-123", // 可选：外部系统ID

&#x20; "page": 1, // 页码

&#x20; "pageSize": 10 // 每页条数

}
```



*   **响应**（200 OK）：



```
{

&#x20; "success": true,

&#x20; "data": {

&#x20;   "list": \[

&#x20;     {

&#x20;       "id": "uuid-123",

&#x20;       "feedbackNo": "A1B2C3",

&#x20;       "type": "功能异常",

&#x20;       "status": "PENDING",

&#x20;       "createdAt": "2025-08-12T10:00:00Z",

&#x20;       "externalSystem": {

&#x20;         "id": "sys-123",

&#x20;         "name": "移动端APP"

&#x20;       }

&#x20;     }

&#x20;   ],

&#x20;   "total": 100, // 总条数

&#x20;   "page": 1,

&#x20;   "pageSize": 10

&#x20; }

}
```

#### （2）处理反馈（更新状态 + 回复）



*   **路径**：`PATCH /api/admin/feedback/{id}`

*   **参数**（Body）：



```
{

&#x20; "status": "SOLVED", // 新状态

&#x20; "reply": "已修复，建议刷新页面重试" // 回复内容（状态为SOLVED/REJECTED时必填）

}
```



*   **响应**（200 OK）：



```
{

&#x20; "success": true,

&#x20; "message": "处理成功"

}
```

#### （3）获取统计数据



*   **路径**：`GET /api/admin/feedback/stats`

*   **参数**（Query）：`startTime`、`endTime`（可选，指定统计时间范围）

*   **响应**（200 OK）：



```
{

&#x20; "success": true,

&#x20; "data": {

&#x20;   "total": 1000, // 总反馈数

&#x20;   "pending": 150, // 待处理数

&#x20;   "todayNew": 30, // 今日新增

&#x20;   "avgProcessTime": "4.5h", // 平均处理时长

&#x20;   "typeStats": \[

&#x20;     {"type": "功能异常", "count": 400, "ratio": "40%"}

&#x20;   ],

&#x20;   "statusStats": \[

&#x20;     {"status": "SOL\</doubaocanvas>
```



```
```

> （注：文档部分内容可能由 AI 生成）